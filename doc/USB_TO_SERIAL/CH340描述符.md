# Linux中查看CH340的描述符信息
CH340接入Linux之后，Linux中输入`sudo lsusb -v -d 1a86:7523`（`sudo lsusb -v -d vid:pid`）可以看到描述符。由于bDeviceClass是255,即厂商自定义的类型。
```
Bus 001 Device 010: ID 1a86:7523 QinHeng Electronics CH340 serial converter
Device Descriptor:
  bLength                18
  bDescriptorType         1
  bcdUSB               1.10
  bDeviceClass          255 Vendor Specific Class
  bDeviceSubClass         0 
  bDeviceProtocol         0 
  bMaxPacketSize0         8
  idVendor           0x1a86 QinHeng Electronics
  idProduct          0x7523 CH340 serial converter
  bcdDevice            2.64
  iManufacturer           0 
  iProduct                2 USB Serial
  iSerial                 0 
  bNumConfigurations      1
  Configuration Descriptor:
    bLength                 9
    bDescriptorType         2
    wTotalLength       0x0027
    bNumInterfaces          1
    bConfigurationValue     1
    iConfiguration          0 
    bmAttributes         0x80
      (Bus Powered)
    MaxPower               98mA
    Interface Descriptor:
      bLength                 9
      bDescriptorType         4
      bInterfaceNumber        0
      bAlternateSetting       0
      bNumEndpoints           3
      bInterfaceClass       255 Vendor Specific Class
      bInterfaceSubClass      1 
      bInterfaceProtocol      2 
      iInterface              0 
      Endpoint Descriptor:
        bLength                 7
        bDescriptorType         5
        bEndpointAddress     0x82  EP 2 IN
        bmAttributes            2
          Transfer Type            Bulk
          Synch Type               None
          Usage Type               Data
        wMaxPacketSize     0x0020  1x 32 bytes
        bInterval               0
      Endpoint Descriptor:
        bLength                 7
        bDescriptorType         5
        bEndpointAddress     0x02  EP 2 OUT
        bmAttributes            2
          Transfer Type            Bulk
          Synch Type               None
          Usage Type               Data
        wMaxPacketSize     0x0020  1x 32 bytes
        bInterval               0
      Endpoint Descriptor:
        bLength                 7
        bDescriptorType         5
        bEndpointAddress     0x81  EP 1 IN
        bmAttributes            3
          Transfer Type            Interrupt
          Synch Type               None
          Usage Type               Data
        wMaxPacketSize     0x0008  1x 8 bytes
        bInterval               1
Device Status:     0x0000
  (Bus Powered)
```
# driver_usb中读取ch340的设备描述符
`crates/driver_usb/src/usb/descriptors/parser.rs`中`parse_single_device_descriptor`函数中添加以下内容可以打印出设备描述符（注意别直接打印，对其有问题），后面匹配驱动的时候根据设备类型和供应商id和设备id就可以作为匹配的条件。
```
                trace!("parsed device.len:{}", dev.len);
                trace!("parsed device.descriptor_type:{}", dev.descriptor_type);
                let cd_usb = dev.cd_usb;
                trace!("parsed device.cd_usb:{}", cd_usb);
                trace!("parsed device.class:{}", dev.class);
                trace!("parsed device.subclass:{}", dev.subclass);
                trace!("parsed device.protocol:{}", dev.protocol);
                trace!("parsed device.max_packet_size0:{}", dev.max_packet_size0);
                let vendor = dev.vendor;
                trace!("parsed device.vendor:{}", vendor);
                let product_id = dev.product_id;
                trace!("parsed device.product_id:{}", product_id);
                let devicee = dev.device;
                trace!("parsed device.device:{}", devicee);
                trace!("parsed device.manufacture:{}", dev.manufacture);
                trace!("parsed device.product:{}", dev.product);
                trace!("parsed device.serial_number:{}", dev.serial_number);
                trace!("parsed device.num_configurations:{}", dev.num_configurations);
```
最终输出的值为：
```
[ 72.631059 0:2 driver_usb::usb::descriptors::parser:159] parse single device desc!
[ 72.639825 0:2 driver_usb::usb::descriptors::parser:222] parse single device desc!
[ 72.648593 0:2 driver_usb::usb::descriptors::parser:422] peeked type:Some(Device)
[ 72.657272 0:2 driver_usb::usb::descriptors::parser:389] parse any desc at current0! type:Some(Device)
[ 72.667778 0:2 driver_usb::usb::descriptors::parser:225] parsed device.len:18
[ 72.676108 0:2 driver_usb::usb::descriptors::parser:226] parsed device.descriptor_type:1
[ 72.685395 0:2 driver_usb::usb::descriptors::parser:228] parsed device.cd_usb:272
[ 72.694075 0:2 driver_usb::usb::descriptors::parser:229] parsed device.class:255
[ 72.702668 0:2 driver_usb::usb::descriptors::parser:230] parsed device.subclass:0
[ 72.711348 0:2 driver_usb::usb::descriptors::parser:231] parsed device.protocol:0
[ 72.720028 0:2 driver_usb::usb::descriptors::parser:232] parsed device.max_packet_size0:8
[ 72.729403 0:2 driver_usb::usb::descriptors::parser:234] parsed device.vendor:6790
[ 72.738170 0:2 driver_usb::usb::descriptors::parser:236] parsed device.product_id:29987
[ 72.747370 0:2 driver_usb::usb::descriptors::parser:238] parsed device.device:612
[ 72.756050 0:2 driver_usb::usb::descriptors::parser:239] parsed device.manufacture:0
[ 72.764991 0:2 driver_usb::usb::descriptors::parser:240] parsed device.product:2
[ 72.773584 0:2 driver_usb::usb::descriptors::parser:241] parsed device.serial_number:0
[ 72.782698 0:2 driver_usb::usb::descriptors::parser:242] parsed device.num_configurations:1
```
很棒，只有一个配置描述符。
# driver_usb中识别的完整的ch340描述符
```
 parsed descriptor:Inited(
    TopologicalUSBDescriptorRoot {
        device: [
            TopologicalUSBDescriptorDevice {
                data: Device {
                    len: 18,
                    descriptor_type: 1,
                    cd_usb: 272,
                    class: 255,
                    subclass: 0,
                    protocol: 0,
                    max_packet_size0: 8,
                    vendor: 6790,
                    product_id: 29987,
                    device: 612,
                    manufacture: 0,
                    product: 2,
                    serial_number: 0,
                    num_configurations: 1,
                },
                child: [
                    TopologicalUSBDescriptorConfiguration {
                        data: Configuration {
                            length: 9,
                            ty: 2,
                            total_length: 39,
                            num_interfaces: 1,
                            config_val: 1,
                            config_string: 0,
                            attributes: 128,
                            max_power: 49,
                        },
                        child: [
                            Interface(
                                [
                                    (
                                        Interface {
                                            len: 9,
                                            descriptor_type: 4,
                                            interface_number: 0,
                                            alternate_setting: 0,
                                            num_endpoints: 3,
                                            interface_class: 255,
                                            interface_subclass: 1,
                                            interface_protocol: 2,
                                            interface: 0,
                                        },
                                        [],
                                        [
                                            Standard(
                                                Endpoint {
                                                    len: 7,
                                                    descriptor_type: 5,
                                                    endpoint_address: 130,
                                                    attributes: 2,
                                                    max_packet_size: 32,
                                                    interval: 0,
                                                    ssc: Some(
                                                        SuperSpeedCmp {
                                                            kind: 0,
                                                            max_burst: 0,
                                                            attributes: 0,
                                                            bytes_per_interval: 0,
                                                        },
                                                    ),
                                                },
                                            ),
                                            Standard(
                                                Endpoint {
                                                    len: 7,
                                                    descriptor_type: 5,
                                                    endpoint_address: 2,
                                                    attributes: 2,
                                                    max_packet_size: 32,
                                                    interval: 0,
                                                    ssc: Some(
                                                        SuperSpeedCmp {
                                                            kind: 0,
                                                            max_burst: 0,
                                                            attributes: 0,
                                                            bytes_per_interval: 0,
                                                        },
                                                    ),
                                                },
                                            ),
                                            Standard(
                                                Endpoint {
                                                    len: 7,
                                                    descriptor_type: 5,
                                                    endpoint_address: 129,
                                                    attributes: 3,
                                                    max_packet_size: 8,
                                                    interval: 1,
                                                    ssc: Some(
                                                        SuperSpeedCmp {
                                                            kind: 0,
                                                            max_burst: 0,
                                                            attributes: 0,
                                                            bytes_per_interval: 0,
                                                        },
                                                    ),
                                                },
                                            ),
                                        ],
                                    ),
                                ],
                            ),
                        ],
                    },
                ],
            },
        ],
        others: [],
        metadata: USBToSerial,
    },
)
```
# 对比
对比两种识别出的描述符

### 设备描述符对比

#### 基本信息
| 项目 | 解析后结构体 | 文本描述符 | 对比结果 |
| --- | --- | --- | --- |
| 描述符长度 (`len` / `bLength`) | 18 | 18 | 一致 |
| 描述符类型 (`descriptor_type` / `bDescriptorType`) | 1 | 1 | 一致 |
| USB 版本 (`cd_usb` / `bcdUSB`) | 272（十进制，转换为十六进制是 `0x0110`，即 1.10） | 1.10 | 一致 |
| 设备类 (`class` / `bDeviceClass`) | 255 | 255（Vendor Specific Class） | 一致 |
| 设备子类 (`subclass` / `bDeviceSubClass`) | 0 | 0 | 一致 |
| 设备协议 (`protocol` / `bDeviceProtocol`) | 0 | 0 | 一致 |
| 端点 0 最大数据包大小 (`max_packet_size0` / `bMaxPacketSize0`) | 8 | 8 | 一致 |
| 厂商 ID (`vendor` / `idVendor`) | 6790（十进制，转换为十六进制是 `0x1a86`） | 0x1a86 | 一致 |
| 产品 ID (`product_id` / `idProduct`) | 29987（十进制，转换为十六进制是 `0x7523`） | 0x7523 | 一致 |
| 设备版本 (`device` / `bcdDevice`) | 612（十进制，转换为十六进制约为 `0x0264`，即 2.64） | 2.64 | 一致 |
| 厂商字符串索引 (`manufacture` / `iManufacturer`) | 0 | 0 | 一致 |
| 产品字符串索引 (`product` / `iProduct`) | 2 | 2 | 一致 |
| 序列号字符串索引 (`serial_number` / `iSerial`) | 0 | 0 | 一致 |
| 配置数量 (`num_configurations` / `bNumConfigurations`) | 1 | 1 | 一致 |

### 配置描述符对比

#### 基本信息
| 项目 | 解析后结构体 | 文本描述符 | 对比结果 |
| --- | --- | --- | --- |
| 描述符长度 (`length` / `bLength`) | 9 | 9 | 一致 |
| 描述符类型 (`ty` / `bDescriptorType`) | 2 | 2 | 一致 |
| 总长度 (`total_length` / `wTotalLength`) | 39（十进制，转换为十六进制是 `0x0027`） | 0x0027 | 一致 |
| 接口数量 (`num_interfaces` / `bNumInterfaces`) | 1 | 1 | 一致 |
| 配置值 (`config_val` / `bConfigurationValue`) | 1 | 1 | 一致 |
| 配置字符串索引 (`config_string` / `iConfiguration`) | 0 | 0 | 一致 |
| 属性 (`attributes` / `bmAttributes`) | 128（十进制，转换为十六进制是 `0x80`） | 0x80（Bus Powered） | 一致 |
| 最大功耗 (`max_power` / `MaxPower`) | 49（单位可能是 2mA，换算后是 98mA） | 98mA | 一致 |

### 接口描述符对比

#### 基本信息
| 项目 | 解析后结构体 | 文本描述符 | 对比结果 |
| --- | --- | --- | --- |
| 描述符长度 (`len` / `bLength`) | 9 | 9 | 一致 |
| 描述符类型 (`descriptor_type` / `bDescriptorType`) | 4 | 4 | 一致 |
| 接口编号 (`interface_number` / `bInterfaceNumber`) | 0 | 0 | 一致 |
| 备用设置 (`alternate_setting` / `bAlternateSetting`) | 0 | 0 | 一致 |
| 端点数量 (`num_endpoints` / `bNumEndpoints`) | 3 | 3 | 一致 |
| 接口类 (`interface_class` / `bInterfaceClass`) | 255 | 255（Vendor Specific Class） | 一致 |
| 接口子类 (`interface_subclass` / `bInterfaceSubClass`) | 1 | 1 | 一致 |
| 接口协议 (`interface_protocol` / `bInterfaceProtocol`) | 2 | 2 | 一致 |
| 接口字符串索引 (`interface` / `iInterface`) | 0 | 0 | 一致 |

### 端点描述符对比

#### 端点 1（`0x82` / `130`）
| 项目 | 解析后结构体 | 文本描述符 | 对比结果 |
| --- | --- | --- | --- |
| 描述符长度 (`len` / `bLength`) | 7 | 7 | 一致 |
| 描述符类型 (`descriptor_type` / `bDescriptorType`) | 5 | 5 | 一致 |
| 端点地址 (`endpoint_address`) | 130（十进制，转换为十六进制是 `0x82`） | 0x82（EP 2 IN） | 一致 |
| 属性 (`attributes` / `bmAttributes`) | 2 | 2（Bulk Transfer） | 一致 |
| 最大数据包大小 (`max_packet_size` / `wMaxPacketSize`) | 32 | 0x0020（1x 32 bytes） | 一致 |
| 间隔 (`interval` / `bInterval`) | 0 | 0 | 一致 |

#### 端点 2（`0x02`）
| 项目 | 解析后结构体 | 文本描述符 | 对比结果 |
| --- | --- | --- | --- |
| 描述符长度 (`len` / `bLength`) | 7 | 7 | 一致 |
| 描述符类型 (`descriptor_type` / `bDescriptorType`) | 5 | 5 | 一致 |
| 端点地址 (`endpoint_address`) | 2（十六进制是 `0x02`） | 0x02（EP 2 OUT） | 一致 |
| 属性 (`attributes` / `bmAttributes`) | 2 | 2（Bulk Transfer） | 一致 |
| 最大数据包大小 (`max_packet_size` / `wMaxPacketSize`) | 32 | 0x0020（1x 32 bytes） | 一致 |
| 间隔 (`interval` / `bInterval`) | 0 | 0 | 一致 |

#### 端点 3（`0x81` / `129`）
| 项目 | 解析后结构体 | 文本描述符 | 对比结果 |
| --- | --- | --- | --- |
| 描述符长度 (`len` / `bLength`) | 7 | 7 | 一致 |
| 描述符类型 (`descriptor_type` / `bDescriptorType`) | 5 | 5 | 一致 |
| 端点地址 (`endpoint_address`) | 129（十进制，转换为十六进制是 `0x81`） | 0x81（EP 1 IN） | 一致 |
| 属性 (`attributes` / `bmAttributes`) | 3 | 3（Interrupt Transfer） | 一致 |
| 最大数据包大小 (`max_packet_size` / `wMaxPacketSize`) | 8 | 0x0008（1x 8 bytes） | 一致 |
| 间隔 (`interval` / `bInterval`) | 1 | 1 | 一致 |
